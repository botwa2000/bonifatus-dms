services:
  backend:
    build: ./backend
    image: bonifatus-backend:latest
    container_name: bonifatus-backend
    ports:
      - "8080:8080"
    secrets:
      - database_url_prod
      - security_secret_key_prod
      - encryption_key_prod
      - google_client_id_prod
      - google_client_secret_prod
      - onedrive_client_id_prod
      - onedrive_client_secret_prod
      - gcp_project_prod
      - brevo_api_key_prod
      - imap_password_prod
      - stripe_secret_key_prod
      - stripe_publishable_key_prod
      - stripe_webhook_secret_prod
      - turnstile_secret_key_prod
    environment:
      # Non-secret configuration (stays as environment variables)
      - APP_HOST=0.0.0.0
      - APP_PORT=8080
      - APP_ENVIRONMENT=production
      - APP_DEBUG_MODE=false
      - APP_CORS_ORIGINS=https://bonidoc.com
      - APP_TITLE=BoniDoc DMS API
      - APP_DESCRIPTION=Document Management System API
      - APP_VERSION=1.0.0
      - NEXTAUTH_URL=https://bonidoc.com
      - GOOGLE_REDIRECT_URI=https://api.bonidoc.com/api/v1/auth/google/callback
      - GOOGLE_DRIVE_FOLDER_NAME=Bonifatus_DMS
      - ONEDRIVE_REDIRECT_URI=https://api.bonidoc.com/api/v1/storage/providers/onedrive/callback
      - ONEDRIVE_FOLDER_NAME=Bonifatus_DMS
      - TRANSLATION_PROVIDER=libretranslate
      - TRANSLATION_LIBRETRANSLATE_URL=http://libretranslate:5000
      - TRANSLATION_DEEPL_URL=https://api-free.deepl.com/v2/translate
      - TRANSLATION_TIMEOUT=30
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_POOL_SIZE=10
      - DATABASE_POOL_RECYCLE=60
      - DATABASE_ECHO=false
      - DATABASE_POOL_PRE_PING=true
      - DATABASE_CONNECT_TIMEOUT=60
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    # Security hardening
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    cap_drop:
      - ALL  # Drop all Linux capabilities
    cap_add:
      - NET_BIND_SERVICE  # Allow binding to ports < 1024 if needed
      - SETUID  # Allow ClamAV to switch to clamav user
      - SETGID  # Allow ClamAV to set supplementary groups
      - CHOWN   # Allow ClamAV entrypoint to set ownership (industry standard)
    # Writable tmpfs volumes (rest of filesystem can be read-only in future)
    tmpfs:
      - /tmp:noexec,nosuid,size=500m  # Temp files
      - /app/logs:noexec,nosuid,size=200m  # Application logs
      - /app/temp:noexec,nosuid,size=1G  # Batch processing temp files
      - /var/log/clamav:size=50m,mode=777  # ClamAV logs (writable by all users in container)
    # Resource limits and Swarm deployment settings
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 5G  # Increased for libpostal language models
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_API_URL: https://api.bonidoc.com
    image: bonifatus-frontend:latest
    container_name: bonifatus-frontend
    ports:
      - "3000:3000"
    restart: unless-stopped
    depends_on:
      - backend
    # Security hardening
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    cap_drop:
      - ALL  # Drop all Linux capabilities
    cap_add:
      - NET_BIND_SERVICE  # Allow binding to port 3000
    # Writable tmpfs volumes
    tmpfs:
      - /tmp:noexec,nosuid,size=200m  # Temp files
      - /app/.next/cache:noexec,nosuid,size=100m  # Next.js cache
    # Resource limits to prevent crypto mining
    deploy:
      resources:
        limits:
          cpus: '1.0'  # Prevent 400% CPU usage like we saw
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 100M

  libretranslate:
    image: libretranslate/libretranslate:latest
    container_name: bonifatus-translator
    restart: unless-stopped
    user: "0:0"  # Run as root to avoid permission issues
    ports:
      - "127.0.0.1:5000:5000"  # Only accessible from localhost
    environment:
      - LT_HOST=0.0.0.0
      - LT_PORT=5000
      - LT_CHAR_LIMIT=5000
      - LT_LOAD_ONLY=en,de,ru,fr  # Only load needed languages to save memory
    volumes:
      - ./translator-data:/app/db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/languages"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s  # LibreTranslate needs time to load models

  redis:
    image: redis:7-alpine
    container_name: bonifatus-redis
    restart: unless-stopped
    ports:
      - "127.0.0.1:6379:6379"  # Only accessible from localhost
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETUID  # Allow user switching
      - SETGID  # Allow group switching
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 50M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  celery-worker:
    build: ./backend
    image: bonifatus-celery-worker:latest
    container_name: bonifatus-celery-worker
    command: celery -A app.celery_app worker --loglevel=info --concurrency=2
    secrets:
      - database_url_prod
      - security_secret_key_prod
      - encryption_key_prod
      - google_client_id_prod
      - google_client_secret_prod
      - onedrive_client_id_prod
      - onedrive_client_secret_prod
      - gcp_project_prod
      - brevo_api_key_prod
      - imap_password_prod
      - stripe_secret_key_prod
      - stripe_publishable_key_prod
      - stripe_webhook_secret_prod
      - turnstile_secret_key_prod
    environment:
      # Non-secret configuration (same as backend)
      - APP_ENVIRONMENT=production
      - APP_DEBUG_MODE=false
      - REDIS_URL=redis://redis:6379/0
      - TRANSLATION_PROVIDER=libretranslate
      - TRANSLATION_LIBRETRANSLATE_URL=http://libretranslate:5000
      - TRANSLATION_DEEPL_URL=https://api-free.deepl.com/v2/translate
      - TRANSLATION_TIMEOUT=30
      - DATABASE_POOL_SIZE=10
      - DATABASE_POOL_RECYCLE=60
      - DATABASE_ECHO=false
      - DATABASE_POOL_PRE_PING=true
      - DATABASE_CONNECT_TIMEOUT=60
      - GOOGLE_DRIVE_FOLDER_NAME=Bonifatus_DMS
      - ONEDRIVE_FOLDER_NAME=Bonifatus_DMS
      - C_FORCE_ROOT=1  # Allow Celery to run as root
    depends_on:
      - redis
      - backend
    restart: unless-stopped
    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETUID  # Allow ClamAV to switch to clamav user
      - SETGID  # Allow ClamAV to set supplementary groups
      - CHOWN   # Allow ClamAV entrypoint to set ownership (industry standard)
    # Writable tmpfs volumes (same as backend)
    tmpfs:
      - /tmp:noexec,nosuid,size=500m
      - /app/logs:noexec,nosuid,size=200m
      - /app/temp:noexec,nosuid,size=1G
    # Health check to prevent Docker Swarm from marking worker as "Complete"
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.celery_app status >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Resource limits and Swarm deployment settings
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 5G
        reservations:
          cpus: '0.5'
          memory: 512M

# Docker Swarm Secrets (external - created via docker secret create)
# All secrets are managed outside Docker Compose for security
# See DEPLOYMENT_GUIDE.md ยง9.8 for secrets management procedures
secrets:
  database_url_prod:
    external: true
  security_secret_key_prod:
    external: true
  encryption_key_prod:
    external: true
  google_client_id_prod:
    external: true
  google_client_secret_prod:
    external: true
  onedrive_client_id_prod:
    external: true
  onedrive_client_secret_prod:
    external: true
  gcp_project_prod:
    external: true
  brevo_api_key_prod:
    external: true
  imap_password_prod:
    external: true
  stripe_secret_key_prod:
    external: true
  stripe_publishable_key_prod:
    external: true
  stripe_webhook_secret_prod:
    external: true
  turnstile_secret_key_prod:
    external: true
