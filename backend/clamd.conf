# ClamAV Daemon Configuration - Production Optimized for Cloud Run
# Memory-efficient configuration for containers with 1-2GB RAM

# Logging
LogFile /var/log/clamav/clamav.log
LogTime yes
LogFileMaxSize 10M
LogVerbose no
LogSyslog no
LogFacility LOG_LOCAL6
LogClean no
LogRotate yes

# Daemon settings
PidFile /var/run/clamav/clamd.pid
TemporaryDirectory /tmp
DatabaseDirectory /var/lib/clamav
LocalSocket /var/run/clamav/clamd.ctl
LocalSocketMode 666

# TCP Socket (for Docker/Cloud Run)
TCPSocket 3310
TCPAddr 127.0.0.1

# Run as daemon
Foreground yes

# MEMORY OPTIMIZATION SETTINGS
# Reduce memory footprint for Cloud Run environment

# Limit concurrent scans (1 = sequential, saves memory)
MaxThreads 1

# Limit queue size
MaxQueue 10

# Stream scanning limits (prevent memory exhaustion)
StreamMaxLength 100M
MaxFileSize 100M
MaxScanSize 100M

# Reduce memory usage during scanning
# Don't load unnecessary signatures
DetectPUA no
AlgorithmicDetection no
ScanPE yes
ScanELF yes
ScanOLE2 yes
ScanPDF yes
ScanMail yes
ScanHTML yes
ScanArchive yes

# Memory limits (critical for Cloud Run)
# MaxFileSize: Maximum size of file to scan
# MaxScanSize: Amount of data scanned per file
# StreamMaxLength: Maximum stream size
MaxRecursion 8
MaxFiles 5000

# Disable bytecode JIT to save memory
BytecodeTimeout 10000
BytecodeSecurity TrustSigned
BytecodeMode Auto

# Disable phishing detection (saves significant memory)
PhishingSignatures no
PhishingScanURLs no

# Disable heuristic checks (saves memory)
HeuristicScanPrecedence no

# Database loading optimization
# Only load essential signatures
ExcludePUA .MSIL
ExcludePUA .NSIS

# Performance tuning
ScanOnAccess no
OnAccessIncludePath /
OnAccessExcludePath /proc
OnAccessExcludePath /sys
OnAccessMaxFileSize 100M

# Idle timeout (shutdown when not used to free memory)
IdleTimeout 300

# User/Group
User clamav

# Self-check
SelfCheck 600

# Exit on out of memory
ExitOnOOM yes
