services:
  backend:
    build: ./backend
    container_name: bonifatus-backend-dev
    ports:
      - "8081:8080"
    secrets:
      - database_url_dev
      - security_secret_key_dev
      - encryption_key_dev
      - google_client_id_dev
      - google_client_secret_dev
      - onedrive_client_id_dev
      - onedrive_client_secret_dev
      - gcp_project_dev
      - brevo_api_key_dev
      - imap_password_dev
      - stripe_secret_key_dev
      - stripe_publishable_key_dev
      - stripe_webhook_secret_dev
      - turnstile_secret_key_dev
    environment:
      # Non-secret configuration
      - APP_HOST=0.0.0.0
      - APP_PORT=8080
      - APP_ENVIRONMENT=development
      - APP_DEBUG_MODE=true
      - APP_CORS_ORIGINS=https://dev.bonidoc.com,https://api-dev.bonidoc.com
      - APP_TITLE=Bonifatus DMS (DEV)
      - APP_DESCRIPTION=Professional Document Management System - Development
      - APP_VERSION=1.0.0-dev
      - NEXTAUTH_URL=https://dev.bonidoc.com
      - GOOGLE_REDIRECT_URI=https://api-dev.bonidoc.com/api/v1/auth/google/callback
      - GOOGLE_DRIVE_FOLDER_NAME=Bonifatus_DMS_DEV
      - ONEDRIVE_REDIRECT_URI=https://dev.bonidoc.com/settings/storage/onedrive/callback
      - ONEDRIVE_FOLDER_NAME=Bonifatus_DMS_Dev
      - TRANSLATION_PROVIDER=libretranslate
      - TRANSLATION_LIBRETRANSLATE_URL=http://libretranslate:5000
      - TRANSLATION_DEEPL_URL=https://api-free.deepl.com/v2/translate
      - TRANSLATION_TIMEOUT=30
      - REDIS_URL=redis://redis:6379/0
      - DATABASE_POOL_SIZE=10
      - DATABASE_POOL_RECYCLE=60
      - DATABASE_ECHO=true
      - DATABASE_POOL_PRE_PING=true
      - DATABASE_CONNECT_TIMEOUT=60
      - CLAMAV_ENABLED=false
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - SETUID
      - SETGID
      - CHOWN
    tmpfs:
      - /tmp:noexec,nosuid,size=500m
      - /app/logs:noexec,nosuid,size=200m
      - /app/temp:noexec,nosuid,size=1G
      - /var/log/clamav:size=50m,mode=777
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 5G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_API_URL: https://api-dev.bonidoc.com
        NEXT_PUBLIC_DEBUG_LOGS: true
    container_name: bonifatus-frontend-dev
    ports:
      - "3001:3000"
    restart: unless-stopped
    depends_on:
      - backend
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
      - /app/.next/cache:noexec,nosuid,size=100m
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 100M

  libretranslate:
    image: libretranslate/libretranslate:latest
    container_name: bonifatus-translator-dev
    restart: unless-stopped
    user: "0:0"
    ports:
      - "127.0.0.1:5001:5000"
    environment:
      - LT_HOST=0.0.0.0
      - LT_PORT=5000
      - LT_CHAR_LIMIT=5000
      - LT_LOAD_ONLY=en,de,ru,fr
    volumes:
      - ./translator-data:/app/db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/languages"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s

  redis:
    image: redis:7-alpine
    container_name: bonifatus-redis-dev
    restart: unless-stopped
    ports:
      - "127.0.0.1:6380:6379"
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETUID
      - SETGID
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 50M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  celery-worker:
    build: ./backend
    container_name: bonifatus-celery-worker-dev
    command: celery -A app.celery_app worker --loglevel=info --concurrency=2
    secrets:
      - database_url_dev
      - security_secret_key_dev
      - encryption_key_dev
      - google_client_id_dev
      - google_client_secret_dev
      - onedrive_client_id_dev
      - onedrive_client_secret_dev
      - gcp_project_dev
      - brevo_api_key_dev
      - imap_password_dev
      - stripe_secret_key_dev
      - stripe_publishable_key_dev
      - stripe_webhook_secret_dev
      - turnstile_secret_key_dev
    environment:
      - APP_ENVIRONMENT=development
      - APP_DEBUG_MODE=true
      - REDIS_URL=redis://redis:6379/0
      - TRANSLATION_PROVIDER=libretranslate
      - TRANSLATION_LIBRETRANSLATE_URL=http://libretranslate:5000
      - TRANSLATION_DEEPL_URL=https://api-free.deepl.com/v2/translate
      - TRANSLATION_TIMEOUT=30
      - DATABASE_POOL_SIZE=10
      - DATABASE_POOL_RECYCLE=60
      - DATABASE_ECHO=true
      - DATABASE_POOL_PRE_PING=true
      - DATABASE_CONNECT_TIMEOUT=60
      - GOOGLE_DRIVE_FOLDER_NAME=Bonifatus_DMS_DEV
      - ONEDRIVE_FOLDER_NAME=Bonifatus_DMS_Dev
      - CLAMAV_ENABLED=false
    depends_on:
      - redis
      - backend
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETUID
      - SETGID
      - CHOWN
    tmpfs:
      - /tmp:noexec,nosuid,size=500m
      - /app/logs:noexec,nosuid,size=200m
      - /app/temp:noexec,nosuid,size=1G
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 5G
        reservations:
          cpus: '0.5'
          memory: 512M

# Docker Swarm Secrets (external - created via docker secret create)
secrets:
  database_url_dev:
    external: true
  security_secret_key_dev:
    external: true
  encryption_key_dev:
    external: true
  google_client_id_dev:
    external: true
  google_client_secret_dev:
    external: true
  onedrive_client_id_dev:
    external: true
  onedrive_client_secret_dev:
    external: true
  gcp_project_dev:
    external: true
  brevo_api_key_dev:
    external: true
  imap_password_dev:
    external: true
  stripe_secret_key_dev:
    external: true
  stripe_publishable_key_dev:
    external: true
  stripe_webhook_secret_dev:
    external: true
  turnstile_secret_key_dev:
    external: true
